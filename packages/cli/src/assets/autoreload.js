// Dioxus-CLI
// https://github.com/DioxusLabs/dioxus/tree/master/packages/cli

(function () {
  var protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
  var url = protocol + "//" + window.location.host + "/_dioxus/ws";
  var poll_interval = 8080;
  var reload_upon_connect = () => {
    window.setTimeout(() => {
      var ws = new WebSocket(url);
      ws.onopen = () => window.location.reload();
      ws.onclose = reload_upon_connect;
    }, poll_interval);
  };

  var ws = new WebSocket(url);
  ws.onmessage = (ev) => {
    if (ev.data.method == "reload") {
      window.location.reload();
    }
    if (ev.data.method == "refresh_assets") {
      const urls = new Set(ev.data.urls);
      const random_query_param =
        "?dioxus=" + Math.random().toString(36).substring(7);
      const url_with_random_query_param = url + random_query_param;

      // Look for any urls that match the one we got from the server and add a random query param to it to force a reload
      // Go through every element attribute
      for (const element of document.querySelectorAll("*")) {
        for (const attribute of element.getAttributeNames()) {
          for (const url of urls) {
            const attribute_value = element.getAttribute(attribute);
            if (attribute_value.startsWith(url)) {
              const remaining = attribute_value.substring(url.length);

              // Create a new attribute that adds a random query param to the url
              const starts_with_query_param = remaining.startsWith("?");
              let new_attribute_value = url_with_random_query_param;

              // If the segment starts with a query param, we need to check modify the query param
              if (starts_with_query_param) {
                let query_params = segment.split("&");
                // check if the first query param looks like a random query param generated by dioxus before we add it
                for (let i = 0; i < query_params.length; i++) {
                  const query_param = query_params[i]
                  if (!query_param.startsWith("dioxus=")) {
                    new_attribute_value += "&" + query_param;
                  }
                }
              }
              element.setAttribute(attribute, new_attribute_value);
            }
          }
        }
      }
    }
  };
  ws.onclose = reload_upon_connect;
})();
